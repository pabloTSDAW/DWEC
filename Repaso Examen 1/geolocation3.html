<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Geolocation 2</title>
    <style>
      #mapa {
        width: 100%;
        height: 400px;
        background-color: grey;
      }
    </style>
  </head>
  <body>

  <h3>Localizaci칩n</h3>
  <div id="mapa"></div>

  <script type="text/javascript">

  /*Let's try to use the geolocation information with the API of Google Maps.
    Use a map to show your location
    Draw a marker in your location
    Find a way to know the address of your location (reverse geocoding).*/

  //Definir fuera las variables para que no de error.
  var posicion;
  var marker;
  var mapa;

  //Comprobar si la geolocalizaci칩n est치 disponible en el navegador:
  function localizacion(){
    if ('geolocation' in navigator) {
      console.log('Geolocation available.');
      return navigator.geolocation.getCurrentPosition(initMap);
    }
    else {
      console.log('Geolocation its not available');
    }
  }


  //Iniciar mapa
  function initMap(pos){
    posicion = {lat: pos.coords.latitude, lng: pos.coords.longitude};
    var directionsService = new google.maps.DirectionsService;
    var directionsDisplay = new google.maps.DirectionsRenderer;
    mapa = new google.maps.Map(document.getElementById("mapa"),{
      zoom: 15,
      center: posicion
    });
    marker = new google.maps.Marker({
      position: posicion,
      map: mapa,
      draggable: true,
      animation: google.maps.Animation.DROP
    });
    var infowindow = new google.maps.InfoWindow;
    var geocoder = new google.maps.Geocoder;
    marker.addListener('click', rebotar);
    geocodeLatLng(geocoder, mapa, infowindow);
    directionsDisplay.setMap(mapa);
		directionsService.route({
            origin: posicion,//db waypoint start
            destination: {lat: 40.4167, lng: -3.70325},//db waypoint end
            travelMode: google.maps.TravelMode.WALKING
        }, function (response, status) {
            if (status === google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
            } else {
                window.alert('Revisa coordenadas y comprueba que la forma de viajar sea acorde');
            }
        });
    }

  function rebotar() {
    if (marker.getAnimation() !== null) {
      marker.setAnimation(null);
    } else {
      marker.setAnimation(google.maps.Animation.BOUNCE);
    }
  }

  //Geolocalizacion inversa

  function geocodeLatLng(geocoder, map, infowindow){
    var latlng = posicion; //Cuidado con este par치metro (tiene que ser el mismo que el de arriba)
    geocoder.geocode({'location': latlng}, function(results, status) {
      if (status === 'OK') {
      if (results[1]) {
        map.setZoom(13);
        infowindow.setContent(results[0].formatted_address);
        infowindow.open(mapa, marker);
      } else {
        window.alert('No results found');
      }
      } else {
      window.alert('Geocoder failed due to: ' + status);
      }
    });
    }

  </script>

  <!--Iportante poner nuestra APIKEY y el callback a la funcion localizaion-->

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCs8GeLs70vepIkA2ZgoerHjkJKKUduFBE&callback=localizacion">
  </script>

  </body>
</html>
